{% extends 'admin_panel/base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Books - Admin Panel{% endblock %}
{% block page_title %}Books Management{% endblock %}

{% block content %}
<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-2">
        <div class="card border-primary">
            <div class="card-body text-center p-2">
                <h6 class="text-muted mb-1 small">Total Books</h6>
                <h4 class="mb-0">{{ stats.total_books }}</h4>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card border-success">
            <div class="card-body text-center p-2">
                <h6 class="text-muted mb-1 small">Active</h6>
                <h4 class="mb-0 text-success">{{ stats.active_books }}</h4>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card border-warning">
            <div class="card-body text-center p-2">
                <h6 class="text-muted mb-1 small">Featured</h6>
                <h4 class="mb-0 text-warning">{{ stats.featured_books }}/4</h4>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card border-info">
            <div class="card-body text-center p-2">
                <h6 class="text-muted mb-1 small">Low Stock</h6>
                <h4 class="mb-0 text-info">{{ stats.low_stock_books }}</h4>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card border-danger">
            <div class="card-body text-center p-2">
                <h6 class="text-muted mb-1 small">Out of Stock</h6>
                <h4 class="mb-0 text-danger">{{ stats.out_of_stock_books }}</h4>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card border-secondary">
            <div class="card-body text-center p-2">
                <h6 class="text-muted mb-1 small">Filtered</h6>
                <h4 class="mb-0">{{ total_count }}</h4>
            </div>
        </div>
    </div>
</div>

<div class="admin-card">
    <div class="admin-card-header">
        <h5><i class="fas fa-book"></i> All Books ({{ page_obj.paginator.count }})</h5>
        <div>
            <a href="{% url 'admin_panel:book_add' %}" class="btn btn-admin-primary">
                <i class="fas fa-plus"></i> Add New Book
            </a>
        </div>
    </div>
    
    <div class="admin-card-body">
        <!-- Advanced Search and Filters -->
        <form method="get" class="mb-4">
            <div class="row g-2">
                <div class="col-md-3">
                    <input type="text" name="q" class="form-control form-control-sm" placeholder="Search: Title, Author, ISBN..." value="{{ request.GET.q }}">
                </div>
                <div class="col-md-2">
                    <select name="category" class="form-select form-select-sm">
                        <option value="">All Categories</option>
                        {% for category in categories %}
                        <option value="{{ category.id }}" {% if request.GET.category == category.id|stringformat:"s" %}selected{% endif %}>{{ category.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <select name="language" class="form-select form-select-sm">
                        <option value="">All Languages</option>
                        {% for code, name in language_choices %}
                        <option value="{{ code }}" {% if request.GET.language == code %}selected{% endif %}>{{ name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <select name="status" class="form-select form-select-sm">
                        <option value="">All Status</option>
                        <option value="active" {% if request.GET.status == 'active' %}selected{% endif %}>‚úì Active</option>
                        <option value="inactive" {% if request.GET.status == 'inactive' %}selected{% endif %}>‚úó Inactive</option>
                        <option value="low_stock" {% if request.GET.status == 'low_stock' %}selected{% endif %}>‚ö† Low Stock</option>
                        <option value="out_of_stock" {% if request.GET.status == 'out_of_stock' %}selected{% endif %}>‚äò Out of Stock</option>
                    </select>
                </div>
                <div class="col-md-1">
                    <select name="is_featured" class="form-select form-select-sm" title="Featured">
                        <option value="">Featured</option>
                        <option value="1" {% if request.GET.is_featured == '1' %}selected{% endif %}>‚≠ê Yes</option>
                        <option value="0" {% if request.GET.is_featured == '0' %}selected{% endif %}>‚òÜ No</option>
                    </select>
                </div>
                <div class="col-md-1">
                    <select name="is_bestseller" class="form-select form-select-sm" title="Bestseller">
                        <option value="">Best</option>
                        <option value="1" {% if request.GET.is_bestseller == '1' %}selected{% endif %}>üèÜ Yes</option>
                        <option value="0" {% if request.GET.is_bestseller == '0' %}selected{% endif %}>No</option>
                    </select>
                </div>
                <div class="col-md-1">
                    <button type="submit" class="btn btn-sm btn-admin-primary w-100"><i class="fas fa-search"></i></button>
                </div>
            </div>
            {% if request.GET.q or request.GET.category or request.GET.language or request.GET.status or request.GET.is_featured or request.GET.is_bestseller %}
            <div class="mt-2">
                <a href="{% url 'admin_panel:book_list' %}" class="btn btn-sm btn-admin-secondary"><i class="fas fa-redo"></i> Clear All Filters</a>
            </div>
            {% endif %}
        </form>

        {% if books %}
        <div class="table-responsive">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th width="70">Cover</th>
                            <th>Title / Author</th>
                            <th>Category</th>
                            <th>Lang</th>
                            <th>Price</th>
                            <th>Stock<br><small class="text-muted fw-normal">(editable)</small></th>
                            <th>Views</th>
                            <th>Sales</th>
                            <th>Active<br><small class="text-muted fw-normal">(toggle)</small></th>
                            <th>Flags</th>
                            <th width="120">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for book in books %}
                        <tr>
                            <td>
                                {% if book.cover_image %}
                                <img src="{{ book.cover_image.url }}" alt="{{ book.title }}" style="width:60px;height:80px;object-fit:cover;" class="img-thumbnail">
                                {% else %}
                                <div class="bg-light d-flex align-items-center justify-content-center" style="width:60px;height:80px;"><i class="fas fa-book text-muted"></i></div>
                                {% endif %}
                            </td>
                            <td>
                                <div class="fw-bold text-truncate" style="max-width:300px;">{{ book.title }}</div>
                                <small class="text-muted">{{ book.author }}</small>
                                {% if book.isbn %}<br><small class="text-muted">ISBN: {{ book.isbn }}</small>{% endif %}
                            </td>
                            <td>{% if book.category %}<span class="badge bg-secondary">{{ book.category.name }}</span>{% else %}-{% endif %}</td>
                            <td><span class="badge bg-info">{{ book.get_language_display }}</span></td>
                            <td>
                                <div>‡ß≥{{ book.price|floatformat:0 }}</div>
                                {% if book.discount_price %}
                                <small class="text-success">‡ß≥{{ book.discount_price|floatformat:0 }}</small>
                                <span class="badge bg-success">-{{ book.discount_percentage }}%</span>
                                {% endif %}
                            </td>
                            <td>
                                <input type="number" class="form-control form-control-sm inline-edit-stock" data-book-id="{{ book.id }}" value="{{ book.stock }}" min="0" style="width:70px;">
                                {% if book.stock == 0 %}<span class="badge bg-danger mt-1">Out</span>
                                {% elif book.stock < 5 %}<span class="badge bg-warning mt-1">Low</span>{% endif %}
                            </td>
                            <td><span class="badge bg-light text-dark">{{ book.views|intcomma }}</span></td>
                            <td><span class="badge bg-primary">{{ book.sales|intcomma }}</span></td>
                            <td>
                                <div class="form-check form-switch">
                                    <input class="form-check-input inline-edit-status" type="checkbox" data-book-id="{{ book.id }}" {% if book.is_active %}checked{% endif %}>
                                </div>
                            </td>
                            <td>
                                {% if book.is_featured %}<span class="badge bg-warning mb-1">‚≠ê Featured</span><br>{% endif %}
                                {% if book.is_bestseller %}<span class="badge bg-success">üèÜ Best</span>{% endif %}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <a href="{% url 'admin_panel:book_edit' book.id %}" class="btn btn-outline-primary" title="Edit"><i class="fas fa-edit"></i></a>
                                    <a href="{% url 'admin_panel:book_delete' book.id %}" class="btn btn-outline-danger" title="Delete" onclick="return confirm('Delete this book?')"><i class="fas fa-trash"></i></a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

        <!-- Pagination -->
            {% if page_obj.has_other_pages %}
            <nav aria-label="Page navigation" class="mt-4">
                <ul class="pagination justify-content-center">
                    {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">First</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">Previous</a>
                    </li>
                    {% endif %}

                    {% for num in page_obj.paginator.page_range %}
                    {% if page_obj.number == num %}
                    <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                    {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ num }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">{{ num }}</a>
                    </li>
                    {% endif %}
                    {% endfor %}

                    {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">Next</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">Last</a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}

            {% else %}
        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i> No books found. 
            {% if request.GET.q or request.GET.category or request.GET.language or request.GET.status %}
            <a href="{% url 'admin_panel:book_list' %}" class="btn btn-sm btn-admin-primary">Clear Filters</a>
            {% else %}
            <a href="{% url 'admin_panel:book_add' %}" class="btn btn-sm btn-admin-primary">Add First Book</a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<script>
// Inline Stock Edit
document.querySelectorAll('.inline-edit-stock').forEach(input => {
    let orig = input.value;
    input.addEventListener('change', function() {
        const id = this.dataset.bookId;
        fetch(`/admin-panel/books/${id}/quick-edit/`, {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded', 'X-CSRFToken': '{{ csrf_token }}'},
            body: `field=stock&value=${this.value}`
        })
        .then(r => r.json())
        .then(d => {
            if (d.success) {
                this.style.borderColor = '#28a745';
                setTimeout(() => this.style.borderColor = '', 1000);
                orig = this.value;
            } else {
                alert('Error: ' + d.message);
                this.value = orig;
            }
        })
        .catch(() => { alert('Error'); this.value = orig; });
    });
});

// Inline Status Edit
document.querySelectorAll('.inline-edit-status').forEach(input => {
    input.addEventListener('change', function() {
        const id = this.dataset.bookId;
        const val = this.checked;
        fetch(`/admin-panel/books/${id}/quick-edit/`, {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded', 'X-CSRFToken': '{{ csrf_token }}'},
            body: `field=is_active&value=${val}`
        })
        .then(r => r.json())
        .then(d => {
            if (!d.success) {
                alert('Error: ' + d.message);
                this.checked = !val;
            }
        })
        .catch(() => { alert('Error'); this.checked = !val; });
    });
});
</script>
{% endblock %}
