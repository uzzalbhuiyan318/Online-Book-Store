{% extends 'base.html' %}
{% load static %}

{% block title %}Rental {{ rental.rental_number }} - BookStore{% endblock %}

{% block content %}
<div class="container my-5">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'rentals:my_rentals' %}">My Rentals</a></li>
            <li class="breadcrumb-item active">{{ rental.rental_number }}</li>
        </ol>
    </nav>

    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h2>Rental Details</h2>
            <p class="text-muted mb-0">Rental ID: <strong>#{{ rental.rental_number }}</strong></p>
        </div>
        <div class="col-md-4 text-md-end">
            {% if rental.status == 'active' %}
                <span class="badge bg-success fs-5">Active</span>
            {% elif rental.status == 'pending' %}
                <span class="badge bg-warning text-dark fs-5">Pending</span>
            {% elif rental.status == 'returned' %}
                <span class="badge bg-info fs-5">Returned</span>
            {% elif rental.status == 'overdue' %}
                <span class="badge bg-danger fs-5">Overdue</span>
            {% else %}
                <span class="badge bg-secondary fs-5">{{ rental.get_status_display }}</span>
            {% endif %}
        </div>
    </div>

    <div class="row">
        <!-- Book Information -->
        <div class="col-lg-4">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-book"></i> Book Information</h5>
                </div>
                <div class="card-body">
                    {% if rental.book.image %}
                    <img src="{{ rental.book.image.url }}" class="img-fluid rounded mb-3" alt="{{ rental.book.title }}">
                    {% else %}
                    <div class="bg-light text-center py-5 rounded mb-3">
                        <i class="fas fa-book fa-4x text-muted"></i>
                    </div>
                    {% endif %}
                    <h5 class="card-title">{{ rental.book.title }}</h5>
                    <p class="text-muted mb-2">by {{ rental.book.author }}</p>
                    <p class="text-muted mb-2">{{ rental.book.category }}</p>
                    <hr>
                    <div class="d-flex justify-content-between">
                        <span>Book Price:</span>
                        <strong>৳{{ rental.book.price }}</strong>
                    </div>
                    <div class="mt-3">
                        <a href="{% url 'books:book_detail' rental.book.slug %}" class="btn btn-outline-primary w-100">
                            <i class="fas fa-eye"></i> View Book
                        </a>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card shadow-sm">
                <div class="card-header bg-secondary text-white">
                    <h6 class="mb-0"><i class="fas fa-bolt"></i> Quick Actions</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        {% if rental.status == 'active' %}
                            {% if rental.can_renew %}
                                <form method="post" action="{% url 'rentals:renew_rental' rental.rental_number %}">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-success w-100" onclick="return confirm('Extend rental by {{ rental.rental_plan.days }} days?')">
                                        <i class="fas fa-sync-alt"></i> Renew ({{ rental.renewal_count }}/{{ settings.max_renewals }})
                                    </button>
                                </form>
                            {% else %}
                                <button class="btn btn-secondary" disabled>
                                    <i class="fas fa-ban"></i> Cannot Renew
                                </button>
                            {% endif %}
                            <form method="post" action="{% url 'rentals:return_rental' rental.rental_number %}">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-warning w-100" onclick="return confirm('Mark this book as returned?')">
                                    <i class="fas fa-undo"></i> Return Book
                                </button>
                            </form>
                        {% elif rental.status == 'pending' %}
                            <form method="post" action="{% url 'rentals:cancel_rental' rental.rental_number %}" style="display: inline;">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-danger"
                                        onclick="return confirm('Cancel this rental?')">
                                    <i class="fas fa-times"></i> Cancel Rental
                                </button>
                            </form>
                        {% elif rental.status == 'returned' %}
                            {% if not rental.feedback %}
                                <a href="{% url 'rentals:submit_feedback' rental.rental_number %}" class="btn btn-info">
                                    <i class="fas fa-star"></i> Submit Feedback
                                </a>
                            {% else %}
                                <div class="alert alert-success mb-0">
                                    <i class="fas fa-check-circle"></i> Feedback submitted
                                </div>
                            {% endif %}
                        {% endif %}
                        <a href="{% url 'rentals:my_rentals' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left"></i> Back to My Rentals
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Rental Details -->
        <div class="col-lg-8">
            <!-- Rental Plan & Dates -->
            <div class="card shadow-sm mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-calendar-alt"></i> Rental Period</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="text-muted small">Rental Plan</label>
                            <div class="fw-bold">{{ rental.rental_plan.name }} ({{ rental.rental_plan.days }} days)</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="text-muted small">Start Date</label>
                            <div class="fw-bold">{{ rental.start_date|date:"d M, Y" }}</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="text-muted small">Due Date</label>
                            <div class="fw-bold {% if rental.is_overdue %}text-danger{% endif %}">
                                {{ rental.due_date|date:"d M, Y" }}
                            </div>
                        </div>
                        {% if rental.return_date %}
                            <div class="col-md-6 mb-3">
                                <label class="text-muted small">Return Date</label>
                                <div class="fw-bold">{{ rental.return_date|date:"d M, Y" }}</div>
                            </div>
                        {% endif %}
                        {% if rental.status == 'active' %}
                            <div class="col-12">
                                {% if rental.is_overdue %}
                                    <div class="alert alert-danger mb-0">
                                        <i class="fas fa-exclamation-triangle"></i> <strong>Overdue by {{ rental.overdue_days }} day{{ rental.overdue_days|pluralize }}!</strong>
                                        <br>Late fee: ৳{{ settings.daily_late_fee }} per day
                                    </div>
                                {% else %}
                                    <div class="alert alert-info mb-0">
                                        <i class="fas fa-clock"></i> {{ rental.days_remaining }} day{{ rental.days_remaining|pluralize }} remaining
                                    </div>
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Payment Details -->
            <div class="card shadow-sm mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-money-bill-wave"></i> Payment Details</h5>
                </div>
                <div class="card-body">
                    <table class="table table-borderless mb-0">
                        <tr>
                            <td>Rental Fee ({{ rental.rental_plan.price_percentage }}%):</td>
                            <td class="text-end">৳{{ rental.rental_price }}</td>
                        </tr>
                        <tr>
                            <td>Security Deposit:</td>
                            <td class="text-end">৳{{ rental.security_deposit }}</td>
                        </tr>
                        <tr class="border-top">
                            <td><strong>Total Amount Paid:</strong></td>
                            <td class="text-end"><strong class="text-primary fs-5">৳{{ rental.total_amount }}</strong></td>
                        </tr>
                        {% if rental.late_fee %}
                            <tr class="border-top">
                                <td class="text-danger"><strong>Late Fee:</strong></td>
                                <td class="text-end"><strong class="text-danger fs-5">৳{{ rental.late_fee }}</strong></td>
                            </tr>
                        {% endif %}
                    </table>
                    {% if rental.status == 'returned' and not rental.late_fee %}
                        <div class="alert alert-success mt-3 mb-0">
                            <i class="fas fa-check-circle"></i> Security deposit refunded on return
                        </div>
                    {% elif rental.status != 'returned' %}
                        <div class="alert alert-info mt-3 mb-0">
                            <i class="fas fa-info-circle"></i> Security deposit will be refunded on timely return
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Renewal Information -->
            {% if rental.renewal_count > 0 %}
            <div class="card shadow-sm mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-sync-alt"></i> Renewal History</h5>
                </div>
                <div class="card-body">
                    <p class="mb-0">This rental has been renewed <strong>{{ rental.renewal_count }}</strong> time{{ rental.renewal_count|pluralize }}.</p>
                    {% if rental.can_renew %}
                        <p class="text-muted small mb-0">You can renew {{ settings.max_renewals|add:"-"|add:rental.renewal_count }} more time{{ settings.max_renewals|add:"-"|add:rental.renewal_count|pluralize }}.</p>
                    {% else %}
                        <p class="text-danger small mb-0">Maximum renewals reached.</p>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Status History -->
            {% if history %}
            <div class="card shadow-sm mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-history"></i> Status History</h5>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        {% for h in history %}
                        <div class="d-flex mb-3">
                            <div class="me-3">
                                {% if h.status == 'active' %}
                                    <i class="fas fa-circle text-success"></i>
                                {% elif h.status == 'pending' %}
                                    <i class="fas fa-circle text-warning"></i>
                                {% elif h.status == 'returned' %}
                                    <i class="fas fa-circle text-info"></i>
                                {% elif h.status == 'cancelled' %}
                                    <i class="fas fa-circle text-danger"></i>
                                {% else %}
                                    <i class="fas fa-circle text-secondary"></i>
                                {% endif %}
                            </div>
                            <div>
                                <strong>{{ h.get_status_display }}</strong>
                                <p class="text-muted small mb-0">{{ h.changed_at|date:"d M, Y H:i" }}</p>
                                {% if h.notes %}
                                    <p class="small mb-0">{{ h.notes }}</p>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Feedback -->
            {% if rental.feedback %}
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-star"></i> Your Feedback</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <small class="text-muted d-block">Book Condition</small>
                            <div>
                                {% for i in "12345" %}
                                    <i class="fas fa-star {% if forloop.counter <= rental.feedback.book_condition_rating %}text-warning{% else %}text-muted{% endif %}"></i>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <small class="text-muted d-block">Service Quality</small>
                            <div>
                                {% for i in "12345" %}
                                    <i class="fas fa-star {% if forloop.counter <= rental.feedback.service_rating %}text-warning{% else %}text-muted{% endif %}"></i>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <small class="text-muted d-block">Overall Rating</small>
                            <div>
                                {% for i in "12345" %}
                                    <i class="fas fa-star {% if forloop.counter <= rental.feedback.overall_rating %}text-warning{% else %}text-muted{% endif %}"></i>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% if rental.feedback.comment %}
                        <hr>
                        <p class="mb-0">{{ rental.feedback.comment }}</p>
                    {% endif %}
                    {% if rental.feedback.admin_response %}
                        <hr>
                        <div class="alert alert-light mb-0">
                            <strong>Admin Response:</strong><br>
                            {{ rental.feedback.admin_response }}
                        </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
