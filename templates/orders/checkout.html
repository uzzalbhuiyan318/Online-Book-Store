{% extends 'base.html' %}
{% load static %}

{% block title %}Checkout - BookStore{% endblock %}

{% block content %}
<div class="container my-5">
    <h2 class="mb-4">Shopping Cart</h2>
    
    <form method="post" id="checkout-form">
        {% csrf_token %}
        <div class="row">
            <!-- Left Column - Cart Items -->
            <div class="col-lg-8">
                <div class="checkout-card">
                    <!-- Select All Header -->
                    <div class="checkout-header">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="selectAll">
                            <label class="form-check-label" for="selectAll">
                                <strong>Select All ({% if cart_items %}{{ cart_items|length }}{% else %}0{% endif %} Item)</strong>
                            </label>
                        </div>
                        <div class="checkout-total">
                            <span class="label">your total:</span>
                            <span class="price-original">৳<span id="totalPrice">{{ subtotal }}</span></span>
                            <span class="price-current">৳<span id="discountedPrice">{{ subtotal }}</span></span>
                        </div>
                    </div>

                    <!-- Cart Items -->
                    {% if cart_items %}
                    <div class="checkout-items">
                        {% for item in cart_items %}
                        <div class="checkout-item" data-price="{{ item.subtotal }}" data-book-id="{{ item.book.id }}">
                            <div class="item-checkbox">
                                <input class="form-check-input item-check" type="checkbox" value="{{ item.book.id }}">
                            </div>
                            
                            <div class="item-image">
                                {% if item.book.cover_image %}
                                <img src="{{ item.book.cover_image.url }}" alt="{{ item.book.title }}">
                                {% else %}
                                <div class="placeholder-image">
                                    <i class="fas fa-book"></i>
                                </div>
                                {% endif %}
                            </div>
                            
                            <div class="item-details">
                                <h6 class="item-title">{{ item.book.title }}</h6>
                                <p class="item-author">{{ item.book.author }}</p>
                                <p class="item-availability">Only {{ item.book.stock }} copies available</p>
                            </div>
                            
                            <div class="item-quantity">
                                <button type="button" class="qty-btn qty-minus" data-book-id="{{ item.book.id }}">−</button>
                                <input type="number" class="qty-input" value="{{ item.quantity }}" min="1" data-book-id="{{ item.book.id }}">
                                <button type="button" class="qty-btn qty-plus" data-book-id="{{ item.book.id }}">+</button>
                            </div>
                            
                            <div class="item-price">
                                <div class="price-current">৳{{ item.book.discount_price|default:item.book.price }}</div>
                                {% if item.book.discount_price %}
                                <div class="price-original">৳{{ item.book.price }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="item-total">
                                <div class="total-price">৳{{ item.subtotal }}</div>
                                <button type="button" class="btn-delete" data-book-id="{{ item.book.id }}" title="Delete">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <p class="text-muted">Your cart is empty</p>
                    </div>
                    {% endif %}
                </div>

                <!-- Delivery & Payment Info -->
                <div class="checkout-card mt-4">
                    <div class="checkout-section-header">
                        <h5>Delivery Information</h5>
                    </div>
                    
                    <div class="checkout-section-body">
                        {% if addresses %}
                        <div class="mb-3">
                            <label class="form-label">Select Delivery Address</label>
                            {% for address in addresses %}
                            <div class="address-item">
                                <input class="form-check-input" type="radio" name="address_id" id="address{{ address.id }}" 
                                       value="{{ address.id }}" {% if address.is_default %}checked{% endif %} required>
                                <label class="form-check-label" for="address{{ address.id }}">
                                    <strong>{{ address.full_name }}</strong> - {{ address.phone }}<br>
                                    {{ address.address_line1 }}{% if address.address_line2 %}, {{ address.address_line2 }}{% endif %}<br>
                                    {{ address.city }}, {{ address.state }} - {{ address.postal_code }}
                                    {% if address.is_default %}<span class="badge bg-primary">Default</span>{% endif %}
                                </label>
                            </div>
                            {% endfor %}
                            <div class="mt-3">
                                <a href="{% url 'accounts:add_address' %}" class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-plus"></i> Add New Address
                                </a>
                            </div>
                        </div>
                        {% else %}
                        <div class="alert alert-warning">
                            You don't have any saved addresses. Please add a delivery address.
                        </div>
                        <div class="form-group mb-3">
                            <label for="full_name" class="form-label">Full Name</label>
                            <input type="text" class="form-control" id="full_name" name="full_name" required>
                        </div>
                        <div class="form-group mb-3">
                            <label for="phone" class="form-label">Phone Number</label>
                            <input type="tel" class="form-control" id="phone" name="phone" required>
                        </div>
                        <div class="form-group mb-3">
                            <label for="address_line1" class="form-label">Address Line 1</label>
                            <input type="text" class="form-control" id="address_line1" name="address_line1" required>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Payment Method -->
                <div class="checkout-card mt-4">
                    <div class="checkout-section-header">
                        <h5>Payment Method</h5>
                    </div>
                    
                    <div class="checkout-section-body">
                        <div class="payment-options">
                            <div class="payment-option">
                                <input class="form-check-input" type="radio" name="payment_method" id="cod" value="cod" checked required>
                                <label class="form-check-label" for="cod">
                                    <i class="fas fa-money-bill-wave"></i> Cash on Delivery
                                </label>
                            </div>
                            <div class="payment-option">
                                <input class="form-check-input" type="radio" name="payment_method" id="bkash" value="bkash" required>
                                <label class="form-check-label" for="bkash">
                                    <i class="fas fa-mobile-alt"></i> bKash
                                </label>
                            </div>
                            <div class="payment-option">
                                <input class="form-check-input" type="radio" name="payment_method" id="nagad" value="nagad" required>
                                <label class="form-check-label" for="nagad">
                                    <i class="fas fa-mobile-alt"></i> Nagad
                                </label>
                            </div>
                            <div class="payment-option">
                                <input class="form-check-input" type="radio" name="payment_method" id="rocket" value="rocket" required>
                                <label class="form-check-label" for="rocket">
                                    <i class="fas fa-mobile-alt"></i> Rocket
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column - Order Summary -->
            <div class="col-lg-4">
                <div class="order-summary-card">
                    <h5 class="summary-title">Checkout Summary</h5>
                    
                    <div class="summary-details">
                        <div class="summary-row">
                            <span class="label">Subtotal</span>
                            <span class="value">৳{{ subtotal }}</span>
                        </div>
                        <div class="summary-row">
                            <span class="label">Delivery and<br>Website Service Charge</span>
                            <span class="value">৳{{ shipping_cost }}</span>
                        </div>
                        {% if discount > 0 %}
                        <div class="summary-row text-success">
                            <span class="label">Discount</span>
                            <span class="value">-৳{{ discount }}</span>
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="summary-divider"></div>
                    
                    <div class="summary-row total-row">
                        <span class="label">Total</span>
                        <span class="value">৳{{ total }}</span>
                    </div>
                    
                    <!-- Promo Code Section -->
                    <div class="promo-section">
                        {% if coupon_code %}
                        <div class="alert alert-success py-2 mb-3">
                            <small>Coupon "{{ coupon_code }}" applied!</small>
                            <button type="button" class="btn-close btn-sm float-end" onclick="removeCoupon()"></button>
                        </div>
                        {% else %}
                        <input type="text" class="form-control" id="coupon_code" placeholder="Apply Promo Code or Voucher Code" readonly>
                        <small class="text-muted mt-2">Apply Promo Code or Voucher Code on the Shipping Page</small>
                        {% endif %}
                    </div>
                    
                    <!-- Checkout Button -->
                    <button type="submit" class="btn btn-checkout w-100">
                        <i class="fas fa-lock"></i> Proceed to Checkout
                    </button>
                    
                    <!-- Secure Checkout Badge -->
                    <div class="secure-checkout mt-3">
                        <i class="fas fa-lock"></i> Secure Checkout
                    </div>
                    
                    <!-- Accepted Payment Methods -->
                    <div class="payment-methods-badge mt-3">
                        <span class="methods-label">We Accept:</span>
                        <div class="methods-icons">
                            <span class="method-icon">bKash</span>
                            <span class="method-icon">Nagad</span>
                            <span class="method-icon">Rocket</span>
                            <span class="method-icon">COD</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
function applyCoupon() {
    const couponCode = document.getElementById('coupon_code').value.trim();
    if (!couponCode) {
        alert('Please enter a coupon code');
        return;
    }
    const applyBtn = event.target;
    applyBtn.disabled = true;
    applyBtn.textContent = 'Applying...';
    
    fetch("{% url 'orders:apply_coupon' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: 'coupon_code=' + encodeURIComponent(couponCode)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.message || 'Invalid coupon code');
            applyBtn.disabled = false;
            applyBtn.textContent = 'Apply';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred. Please try again.');
        applyBtn.disabled = false;
        applyBtn.textContent = 'Apply';
    });
}

function removeCoupon() {
    if (!confirm('Remove coupon code?')) {
        return;
    }
    fetch("{% url 'orders:remove_coupon' %}", {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(() => location.reload());
}

document.addEventListener('DOMContentLoaded', function() {
    const selectAllCheckbox = document.getElementById('selectAll');
    const itemCheckboxes = document.querySelectorAll('.item-check');
    
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            itemCheckboxes.forEach(cb => cb.checked = this.checked);
        });
    }
    
    itemCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const allChecked = Array.from(itemCheckboxes).every(cb => cb.checked);
            if (selectAllCheckbox) selectAllCheckbox.checked = allChecked;
        });
    });
});
</script>
{% endblock %}
