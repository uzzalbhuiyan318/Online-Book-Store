{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Browse Books - BookStore{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <!-- Filters Sidebar -->
        <div class="col-md-3">
            <div class="filter-sidebar">
            <div class="filter-card">
                <div class="filter-header">
                    <i class="fas fa-sliders-h"></i> Filters
                </div>
                <div class="filter-body">
                    <form method="get" id="filterForm">
                        <!-- Category Filter -->
                        <div class="filter-group">
                            <label class="filter-label">Category</label>
                            <select name="category" class="filter-select" onchange="this.form.submit()">
                                <option value="">All Categories</option>
                                {% for cat in categories %}
                                <option value="{{ cat.slug }}" {% if request.GET.category == cat.slug %}selected{% endif %}>
                                    {{ cat.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- Price Range -->
                        <div class="filter-group">
                            <label class="filter-label">Price</label>
                            <div class="price-range-container">
                                <div class="price-values">
                                    <span class="price-value price-min">৳<span id="minPriceDisplay">{{ request.GET.min_price|default:'0' }}</span></span>
                                    <span class="price-value price-max">৳<span id="maxPriceDisplay">{{ request.GET.max_price|default:'5400' }}</span></span>
                                </div>
                                <div class="range-slider-wrapper">
                                    <div class="range-slider">
                                        <div class="range-track"></div>
                                        <div class="range-fill" id="rangeFill"></div>
                                        <input type="range" name="min_price" id="minPriceRange" min="0" max="5400" step="50" value="{{ request.GET.min_price|default:'0' }}" class="range-input range-min">
                                        <input type="range" name="max_price" id="maxPriceRange" min="0" max="5400" step="50" value="{{ request.GET.max_price|default:'5400' }}" class="range-input range-max">
                                    </div>
                                    <div class="range-labels">
                                        <span class="range-label-min">0</span>
                                        <span class="range-label-mid">1 350</span>
                                        <span class="range-label-mid2">2 700</span>
                                        <span class="range-label-mid3">4 050</span>
                                        <span class="range-label-max">5 400</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Language -->
                        <div class="filter-group">
                            <label class="filter-label">Language</label>
                            <select name="language" class="filter-select" onchange="this.form.submit()">
                                    <option value="">All Languages</option>
                                    <option value="en" {% if request.GET.language == "en" %}selected{% endif %}>English</option>
                                    <option value="bn" {% if request.GET.language == "bn" %}selected{% endif %}>বাংলা</option>
                            </select>
                        </div>
                        
                        <!-- Author Filter -->
                        <div class="filter-group">
                            <label class="filter-label">Author</label>
                            <select name="author" class="filter-select" onchange="this.form.submit()">
                                <option value="">All Authors</option>
                                {% for author in authors %}
                                <option value="{{ author }}" {% if request.GET.author == author %}selected{% endif %}>
                                    {{ author }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- Publisher Filter -->
                        <div class="filter-group">
                            <label class="filter-label">Publisher</label>
                            <select name="publisher" class="filter-select" onchange="this.form.submit()">
                                <option value="">All Publishers</option>
                                {% for publisher in publishers %}
                                <option value="{{ publisher }}" {% if request.GET.publisher == publisher %}selected{% endif %}>
                                    {{ publisher }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="filter-actions">
                            <button type="submit" class="btn-filter-apply">
                                <i class="fas fa-check"></i> Apply Filters
                            </button>
                            <a href="{% url 'books:book_list' %}" class="btn-filter-clear">
                                <i class="fas fa-redo"></i> Clear Filters
                            </a>
                        </div>
                    </form>
                </div>
            </div>
            </div>
        </div>
        
        <!-- Books Grid -->
        <div class="col-md-9">
            <!-- Rental Plan Filter Banner -->
            {% if selected_rental_plan %}
            <div class="alert alert-info mb-4" role="alert">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <i class="fas fa-filter me-2"></i>
                        <strong>Filtering by Rental Plan:</strong> {{ selected_rental_plan.name }}
                        <span class="badge bg-primary ms-2">{{ selected_rental_plan.days }} days</span>
                    </div>
                    <a href="{% url 'books:book_list' %}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-times me-1"></i> Clear Filter
                    </a>
                </div>
            </div>
            {% endif %}
            
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>All Books ({{ page_obj.paginator.count }})</h2>
                
                <!-- Sort Options -->
                <form method="get" class="d-flex gap-2">
                    <select name="sort" class="form-select form-select-sm" onchange="this.form.submit()" style="width: 200px;">
                        <option value="">Sort by</option>
                        <option value="title" {% if request.GET.sort == "title" %}selected{% endif %}>Title (A-Z)</option>
                        <option value="-title" {% if request.GET.sort == "-title" %}selected{% endif %}>Title (Z-A)</option>
                        <option value="price" {% if request.GET.sort == "price" %}selected{% endif %}>Price: Low to High</option>
                        <option value="-price" {% if request.GET.sort == "-price" %}selected{% endif %}>Price: High to Low</option>
                        <option value="-created_at" {% if request.GET.sort == "-created_at" %}selected{% endif %}>Newest First</option>
                        <option value="-sales" {% if request.GET.sort == "-sales" %}selected{% endif %}>Best Selling</option>
                    </select>
                </form>
            </div>
            
            {% if books %}
            <div class="row g-4">
                {% for book in books %}
                <div class="col-lg-3 col-md-4 col-sm-6 col-6">
                    <div class="card book-card-premium">
                        <!-- Discount Badge -->
                        {% if book.discount_percentage %}
                        <span class="badge badge-discount">
                            <strong>{{ book.discount_percentage|floatformat:0 }}%</strong>
                            <span style="font-size: 10px; font-weight: 600;">OFF</span>
                        </span>
                        {% endif %}
                        
                        <!-- Book Cover Image -->
                        <div class="book-image-container">
                            <a href="{% url 'books:book_detail' book.slug %}">
                                {% if book.cover_image %}
                                <img src="{{ book.cover_image.url }}" class="book-cover-img" alt="{{ book.title }}">
                                {% else %}
                                <div class="book-cover-placeholder">
                                    <i class="fas fa-book"></i>
                                </div>
                                {% endif %}
                            </a>
                            <!-- Quick Add Wishlist Button -->
                            <button class="btn btn-wishlist-quick toggle-wishlist {% if book.id in wishlist_book_ids %}active{% endif %}" 
                                    data-book-id="{{ book.id }}"
                                    data-in-wishlist="{% if book.id in wishlist_book_ids %}true{% else %}false{% endif %}">
                                <i class="{% if book.id in wishlist_book_ids %}fas{% else %}far{% endif %} fa-heart"></i>
                            </button>
                        </div>
                        
                        <!-- Card Body -->
                        <div class="card-body book-card-body">
                            <!-- Title -->
                            <h5 class="book-title">
                                <a href="{% url 'books:book_detail' book.slug %}" class="text-decoration-none">{{ book.title|truncatewords:5 }}</a>
                            </h5>
                            
                            <!-- Author -->
                            <p class="book-author">{{ book.author }}</p>
                            
                            <!-- Rating -->
                            {% if book.average_rating %}
                            <div class="book-rating mb-2">
                                <div class="rating-stars">
                                    {% for i in "12345" %}
                                        {% if forloop.counter <= book.average_rating %}
                                        <i class="fas fa-star"></i>
                                        {% else %}
                                        <i class="far fa-star"></i>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                                <small class="review-count">({{ book.total_reviews }})</small>
                            </div>
                            {% endif %}
                            
                            <!-- Price Section -->
                            <div class="price-section mb-3">
                                {% if book.discount_price %}
                                <span class="price-current">৳{{ book.discount_price|floatformat:2 }}</span>
                                <span class="price-original">৳{{ book.price|floatformat:2 }}</span>
                                {% else %}
                                <span class="price-current">৳{{ book.price|floatformat:2 }}</span>
                                {% endif %}
                            </div>
                            
                            <!-- Add to Cart Button -->
                            {% if book.stock > 0 %}
                            <button class="btn btn-add-to-cart w-100 add-to-cart" data-book-id="{{ book.id }}">
                                Add to Cart
                            </button>
                            {% else %}
                            <button class="btn btn-out-of-stock w-100" disabled>
                                <i class="fas fa-times-circle"></i> Out of Stock
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <!-- Pagination -->
            {% if page_obj.has_other_pages %}
            <nav class="mt-5">
                <ul class="pagination justify-content-center">
                    {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}">First</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}">Previous</a>
                    </li>
                    {% endif %}
                    
                    {% for num in page_obj.paginator.page_range %}
                        {% if page_obj.number == num %}
                        <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                        <li class="page-item"><a class="page-link" href="?page={{ num }}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}">{{ num }}</a></li>
                        {% endif %}
                    {% endfor %}
                    
                    {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}">Next</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}">Last</a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
            
            {% else %}
            <div class="text-center py-5">
                <i class="fas fa-search fa-5x text-muted mb-4"></i>
                <h3>No books found</h3>
                <p class="text-muted">Try adjusting your filters or search criteria.</p>
                <a href="{% url 'books:book_list' %}" class="btn btn-primary">View All Books</a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
// Add to Cart functionality
document.querySelectorAll('.add-to-cart').forEach(button => {
    button.addEventListener('click', function() {
        const bookId = this.dataset.bookId;
        const btn = this;
        const originalText = btn.innerHTML;
        
        // Disable button and show loading
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';
        
        fetch(`/cart/add/${bookId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success feedback
                btn.innerHTML = '<i class="fas fa-check"></i> Added!';
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-success');
                
                // Update cart count in navbar
                const cartBadge = document.querySelector('.cart-count');
                if (cartBadge && data.cart_count) {
                    cartBadge.textContent = data.cart_count;
                    cartBadge.style.display = 'inline-block';
                }
                
                // Reset button after 2 seconds
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-primary');
                    btn.disabled = false;
                }, 2000);
            } else {
                // Silent error - just reset button
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            // Silent error - just reset button
            btn.innerHTML = originalText;
            btn.disabled = false;
        });
    });
});

// Wishlist functionality
document.querySelectorAll('.toggle-wishlist').forEach(button => {
    button.addEventListener('click', function() {
        {% if not user.is_authenticated %}
        window.location.href = '{% url "accounts:login" %}?next={{ request.path }}';
        return;
        {% endif %}
        
        const bookId = this.dataset.bookId;
        const btn = this;
        const icon = btn.querySelector('i');
        const isInWishlist = icon.classList.contains('fas');
        
        // Determine action
        const action = isInWishlist ? 'remove' : 'add';
        const url = action === 'add' ? `/wishlist/add/${bookId}/` : `/wishlist/remove/${bookId}/`;
        
        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Toggle heart icon
                if (action === 'add') {
                    icon.classList.remove('far');
                    icon.classList.add('fas');
                    btn.classList.remove('btn-outline-secondary');
                    btn.classList.add('btn-danger');
                } else {
                    icon.classList.remove('fas');
                    icon.classList.add('far');
                    btn.classList.remove('btn-danger');
                    btn.classList.add('btn-outline-secondary');
                }
                
                // Show brief success animation
                btn.classList.add('animate__animated', 'animate__heartBeat');
                setTimeout(() => {
                    btn.classList.remove('animate__animated', 'animate__heartBeat');
                }, 1000);
            } else {
                alert(data.message || 'Operation failed');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred. Please try again.');
        });
    });
});

// Price Range Slider functionality
const minPriceRange = document.getElementById('minPriceRange');
const maxPriceRange = document.getElementById('maxPriceRange');
const minPriceDisplay = document.getElementById('minPriceDisplay');
const maxPriceDisplay = document.getElementById('maxPriceDisplay');
const rangeFill = document.getElementById('rangeFill');

function updateRangeSlider() {
    const minVal = parseInt(minPriceRange.value);
    const maxVal = parseInt(maxPriceRange.value);
    const minRange = parseInt(minPriceRange.min);
    const maxRange = parseInt(minPriceRange.max);
    
    // Ensure min doesn't exceed max
    if (minVal > maxVal - 100) {
        minPriceRange.value = maxVal - 100;
    }
    
    // Ensure max doesn't go below min
    if (maxVal < minVal + 100) {
        maxPriceRange.value = minVal + 100;
    }
    
    // Update display values
    minPriceDisplay.textContent = minPriceRange.value;
    maxPriceDisplay.textContent = maxPriceRange.value;
    
    // Update range fill
    const minPercent = ((minPriceRange.value - minRange) / (maxRange - minRange)) * 100;
    const maxPercent = ((maxPriceRange.value - minRange) / (maxRange - minRange)) * 100;
    
    rangeFill.style.left = minPercent + '%';
    rangeFill.style.width = (maxPercent - minPercent) + '%';
}

if (minPriceRange && maxPriceRange) {
    minPriceRange.addEventListener('input', updateRangeSlider);
    maxPriceRange.addEventListener('input', updateRangeSlider);
    
    // Initialize slider on page load
    updateRangeSlider();
}
</script>
{% endblock %}
